-- Davzx Fix Lag GUI (v5) - UI resized for mobile, single "Main" tab, removed texture remover, universal support
-- Ajustes:
--  - Tamanho responsivo e reduzido para mobile
--  - Removidas categorias (apenas "Main" permanece)
--  - Removido script que removia texturas (comportamento removido por completo)
--  - Botões de fechar (X) e minimizar/restaurar (-) funcionais
--  - Compatível com diferentes experiências (sem dependência de jogo específico)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

-- Espera segura por LocalPlayer
local LocalPlayer = Players.LocalPlayer
if not LocalPlayer then
	LocalPlayer = Players.PlayerAdded:Wait()
end
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

local function new(class, props)
	local obj = Instance.new(class)
	if props then
		for k, v in pairs(props) do
			if k ~= "Parent" then
				pcall(function() obj[k] = v end)
			end
		end
		if props.Parent then
			pcall(function() obj.Parent = props.Parent end)
		end
	end
	return obj
end

-- cleanup old GUIs
for _, name in ipairs({"DavzxFixLagGui_v2", "DavzxFixLagGui_v3", "DavzxFixLagGui_v4", "DavzxFixLagGui_v5"}) do
	local ex = PlayerGui:FindFirstChild(name)
	if ex then ex:Destroy() end
end

local screenGui = new("ScreenGui", {
	Name = "DavzxFixLagGui_v5",
	Parent = PlayerGui,
	ResetOnSpawn = false,
	ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
})

-- Main window (inicialmente responsivo: usa escala para mobile)
local main = new("Frame", {
	Name = "Main",
	AnchorPoint = Vector2.new(0.5, 0.5),
	Position = UDim2.new(0.5, 0, 0.5, 0),
	-- tamanho inicial em escala; será ajustado por adjustForScreen()
	Size = UDim2.new(0.9, 0, 0.8, 0),
	BackgroundColor3 = Color3.fromRGB(25, 27, 29),
	BorderSizePixel = 0,
	Parent = screenGui,
})
new("UICorner", { Parent = main, CornerRadius = UDim.new(0, 10) })
main.ClipsDescendants = true

-- Topbar
local topbar = new("Frame", { Parent = main, Size = UDim2.new(1, 0, 0, 48), BackgroundTransparency = 1 })
local title = new("TextLabel", { Parent = topbar, Text = "Davzx Fix Lag", Font = Enum.Font.GothamBold, TextSize = 18, TextColor3 = Color3.fromRGB(230, 230, 230), BackgroundTransparency = 1, Position = UDim2.new(0, 14, 0, 6), Size = UDim2.new(0, 260, 0, 28), TextXAlignment = Enum.TextXAlignment.Left })
local subtitle = new("TextLabel", { Parent = topbar, Text = "Gerenciador de scripts", Font = Enum.Font.Gotham, TextSize = 12, TextColor3 = Color3.fromRGB(160, 165, 170), BackgroundTransparency = 1, Position = UDim2.new(0, 14, 0, 28), Size = UDim2.new(0, 260, 0, 18), TextXAlignment = Enum.TextXAlignment.Left })

-- Close (X) button - sempre visível
local btnClose = new("TextButton", {
	Parent = topbar,
	Name = "Close",
	Text = "X",
	Font = Enum.Font.GothamBold,
	TextSize = 16,
	TextColor3 = Color3.fromRGB(220, 220, 220),
	BackgroundColor3 = Color3.fromRGB(40, 42, 44),
	Size = UDim2.new(0, 36, 0, 28),
	Position = UDim2.new(1, -46, 0, 10),
	AutoButtonColor = true,
	BorderSizePixel = 0,
})
new("UICorner", { Parent = btnClose, CornerRadius = UDim.new(0, 6) })

-- Minimize/Restore button - sempre visível
local btnMin = new("TextButton", {
	Parent = topbar,
	Name = "Min",
	Text = "—",
	Font = Enum.Font.GothamBold,
	TextSize = 20,
	TextColor3 = Color3.fromRGB(220, 220, 220),
	BackgroundColor3 = Color3.fromRGB(40, 42, 44),
	Size = UDim2.new(0, 36, 0, 28),
	Position = UDim2.new(1, -92, 0, 10),
	AutoButtonColor = true,
	BorderSizePixel = 0
})
new("UICorner", { Parent = btnMin, CornerRadius = UDim.new(0, 6) })

-- Content (ocupando a maior parte do painel; removida a sidebar/categorias)
local content = new("Frame", { Parent = main, Name = "Content", Size = UDim2.new(1, -24, 1, -72), Position = UDim2.new(0, 12, 0, 56), BackgroundColor3 = Color3.fromRGB(14, 16, 18), BorderSizePixel = 0 })
new("UICorner", { Parent = content, CornerRadius = UDim.new(0, 8) })
local contentHeader = new("Frame", { Parent = content, Size = UDim2.new(1, 0, 0, 56), BackgroundTransparency = 1 })
local currentCatLabel = new("TextLabel", { Parent = contentHeader, Text = "Main", Font = Enum.Font.GothamBold, TextSize = 16, TextColor3 = Color3.fromRGB(230, 230, 230), BackgroundTransparency = 1, Position = UDim2.new(0, 12, 0, 12), Size = UDim2.new(0.6, 0, 0, 28), TextXAlignment = Enum.TextXAlignment.Left })

-- Scripts list / main content holder
local scriptsFrame = new("ScrollingFrame", { Parent = content, Name = "ScriptsList", BackgroundTransparency = 1, Size = UDim2.new(1, -24, 1, -80), Position = UDim2.new(0, 12, 0, 68), ScrollBarThickness = 8, CanvasSize = UDim2.new(0,0,0,0) })
local scriptsLayout = new("UIListLayout", { Parent = scriptsFrame, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 10) })
scriptsLayout.VerticalAlignment = Enum.VerticalAlignment.Top

-- helpers
local function clearChildren(parent)
	for _, c in ipairs(parent:GetChildren()) do
		if not (c:IsA("UIListLayout") or c:IsA("UIPadding") or c:IsA("UIScale") or c:IsA("UIGridLayout")) then
			c:Destroy()
		end
	end
end

-- detect executor (heurística simples)
local function detectExecutor()
	local ok, res = pcall(function()
		if type(identifyexecutor) == "function" then
			return identifyexecutor()
		end
	end)
	if ok and type(res) == "string" and res ~= "" then
		return res
	end

	if type(syn) == "table" or type(syn) == "userdata" then
		local ver = "Synapse X"
		if syn and type(syn) == "table" and syn.version then
			ver = ver .. " " .. tostring(syn.version)
		end
		return ver
	end
	if rawget(_G, "KRNL_LOADED") or rawget(_G, "KRNL") then
		return "KRNL"
	end
	if rawget(_G, "is_sirhurt_closure") then
		return "SirHurt"
	end
	if rawget(_G, "secure_load") then
		return "SecureLoad"
	end
	if rawget(_G, "protosmasher") or rawget(_G, "PROTOSMASHER_LOADED") then
		return "ProtoSmasher"
	end
	if type(getexecutor) == "function" then
		local ok2, name = pcall(getexecutor)
		if ok2 and type(name) == "string" and name ~= "" then
			return name
		end
		return "Unknown (getexecutor)"
	end
	return "Unknown"
end

local function detectExecutorVersion()
	local ok, res = pcall(function()
		if type(identifyexecutor) == "function" then
			return identifyexecutor()
		end
	end)
	if ok and type(res) == "string" and res ~= "" then
		return res
	end
	if syn and type(syn) == "table" and syn.version then
		return tostring(syn.version)
	end
	return "Unknown"
end

-- Função para criar o painel "Main" com avatar e supported info (mantido como pedido)
local function showMainInfo()
	clearChildren(scriptsFrame)

	-- Container para layout (dois painéis)
	local container = new("Frame", { Parent = scriptsFrame, Size = UDim2.new(1, 0, 0, 360), BackgroundTransparency = 1 })
	new("UICorner", { Parent = container, CornerRadius = UDim.new(0, 6) })

	-- Left column
	local left = new("Frame", { Parent = container, Size = UDim2.new(0.62, 0, 1, 0), Position = UDim2.new(0, 0, 0, 0), BackgroundTransparency = 1 })
	new("TextLabel", { Parent = left, Text = "Info Main", Font = Enum.Font.GothamBold, TextSize = 14, TextColor3 = Color3.fromRGB(210,210,210), BackgroundTransparency = 1, Position = UDim2.new(0, 0, 0, 0), Size = UDim2.new(1, 0, 0, 24), TextXAlignment = Enum.TextXAlignment.Left })

	-- Avatar frame
	local avatarFrame = new("Frame", { Parent = left, Position = UDim2.new(0, 0, 0, 28), Size = UDim2.new(1, 0, 0, 160), BackgroundColor3 = Color3.fromRGB(23,25,27), BorderSizePixel = 0 })
	new("UICorner", { Parent = avatarFrame, CornerRadius = UDim.new(0,6) })

	local avatarImg = new("ImageLabel", {
		Parent = avatarFrame,
		Size = UDim2.new(0, 120, 0, 120),
		Position = UDim2.new(0.02, 0, 0.1, 0),
		BackgroundTransparency = 1,
		Image = "",
		ScaleType = Enum.ScaleType.Fit,
	})
	do
		local ok, url = pcall(function()
			return Players:GetUserThumbnailAsync(LocalPlayer.UserId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size420x420)
		end)
		if ok and type(url) == "string" and url ~= "" then
			avatarImg.Image = url
		else
			avatarImg.BackgroundColor3 = Color3.fromRGB(40,40,40)
		end
	end

	-- Container de seções (Main Credits, Version, Support)
	local sectionsContainer = new("Frame", { Parent = left, Position = UDim2.new(0, 0, 0, 200), Size = UDim2.new(1, 0, 0, 152), BackgroundTransparency = 1 })
	local secLayout = new("UIListLayout", { Parent = sectionsContainer, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 8) })

	local function makeSection(parent, titleText, titleColor)
		local section = new("Frame", { Parent = parent, Size = UDim2.new(1, 0, 0, 64), BackgroundTransparency = 1 })
		new("TextLabel", { Parent = section, Text = titleText, Font = Enum.Font.GothamBold, TextSize = 13, TextColor3 = titleColor or Color3.fromRGB(200,200,200), BackgroundTransparency = 1, Position = UDim2.new(0, 0, 0, 6), Size = UDim2.new(1, 0, 0, 18), TextXAlignment = Enum.TextXAlignment.Left })
		local content = new("TextLabel", { Parent = section, Text = "", Font = Enum.Font.Gotham, TextSize = 12, TextColor3 = Color3.fromRGB(175,175,175), BackgroundTransparency = 1, Position = UDim2.new(0, 0, 0, 28), Size = UDim2.new(1, 0, 0, 30), TextWrapped = true, TextXAlignment = Enum.TextXAlignment.Left })
		return section, content
	end

	local _, creditsContent = makeSection(sectionsContainer, "Main Credits", Color3.fromRGB(220, 40, 80))
	creditsContent.Text = "Script Criado Por Davzx & Sua Equipe."

	local _, versionContent = makeSection(sectionsContainer, "Version", Color3.fromRGB(60,120,220))
	versionContent.Text = "Versão V1, Versão beta, em breve novos updates."

	local _, supportContent = makeSection(sectionsContainer, "Support", Color3.fromRGB(160,160,160))
	supportContent.Text = "" -- vazio por enquanto

	-- Right column (Supported)
	local right = new("Frame", { Parent = container, Size = UDim2.new(0.36, 0, 1, 0), Position = UDim2.new(0.64, 12, 0, 0), BackgroundTransparency = 1 })
	new("TextLabel", { Parent = right, Text = "Supported", Font = Enum.Font.GothamBold, TextSize = 14, TextColor3 = Color3.fromRGB(210,210,210), BackgroundTransparency = 1, Position = UDim2.new(0, 0, 0, 0), Size = UDim2.new(1, 0, 0, 24), TextXAlignment = Enum.TextXAlignment.Left })

	local supportedBox = new("Frame", { Parent = right, Position = UDim2.new(0, 0, 0, 28), Size = UDim2.new(1, 0, 0, 300), BackgroundColor3 = Color3.fromRGB(23,25,27), BorderSizePixel = 0 })
	new("UICorner", { Parent = supportedBox, CornerRadius = UDim.new(0,6) })
	new("UIPadding", { Parent = supportedBox, PaddingLeft = UDim.new(0,8), PaddingTop = UDim.new(0,8) })
	local supLayout = new("UIListLayout", { Parent = supportedBox, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0,6) })

	-- Preencher informações de Supported: executor e possível versão
	local executorName = detectExecutor()
	local executorVersion = detectExecutorVersion()

	new("TextLabel", { Parent = supportedBox, Text = "Executor Info:", Font = Enum.Font.GothamBold, TextSize = 13, TextColor3 = Color3.fromRGB(235,105,155), BackgroundTransparency = 1, Size = UDim2.new(1, -16, 0, 18), TextXAlignment = Enum.TextXAlignment.Left })
	new("TextLabel", { Parent = supportedBox, Text = "Executor: " .. tostring(executorName), Font = Enum.Font.Gotham, TextSize = 12, TextColor3 = Color3.fromRGB(200,200,200), BackgroundTransparency = 1, Size = UDim2.new(1, -16, 0, 18), TextXAlignment = Enum.TextXAlignment.Left })

	new("TextLabel", { Parent = supportedBox, Text = "Client Version:", Font = Enum.Font.GothamBold, TextSize = 13, TextColor3 = Color3.fromRGB(200,160,50), BackgroundTransparency = 1, Size = UDim2.new(1, -16, 0, 18), TextXAlignment = Enum.TextXAlignment.Left })
	new("TextLabel", { Parent = supportedBox, Text = "Versão: " .. tostring(executorVersion), Font = Enum.Font.Gotham, TextSize = 12, TextColor3 = Color3.fromRGB(200,200,200), BackgroundTransparency = 1, Size = UDim2.new(1, -16, 0, 18), TextXAlignment = Enum.TextXAlignment.Left })

	-- Ajuste final do CanvasSize para o ScrollingFrame principal
	delay(0.05, function()
		local totalY = 360
		pcall(function() scriptsFrame.CanvasSize = UDim2.new(0, 0, 0, totalY) end)
	end)
end

-- refreshScripts agora sempre mostra apenas o painel Main
local function refreshScripts()
	clearChildren(scriptsFrame)
	showMainInfo()
end

-- canvas updates (apenas para scriptsFrame)
local function connectCanvasUpdates()
	scriptsLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
		scriptsFrame.CanvasSize = UDim2.new(0, 0, 0, scriptsLayout.AbsoluteContentSize.Y + 12)
	end)
	scriptsFrame.CanvasSize = UDim2.new(0, 0, 0, scriptsLayout.AbsoluteContentSize.Y + 12)
end

-- toast simples
local function toast(text, time)
	time = time or 3
	local tframe = new("TextLabel", { Parent = screenGui, Text = text, Font = Enum.Font.Gotham, TextSize = 14, TextColor3 = Color3.fromRGB(240, 240, 240), BackgroundColor3 = Color3.fromRGB(28, 30, 32), Size = UDim2.new(0, 380, 0, 40), Position = UDim2.new(1, -400, 1, -80), BorderSizePixel = 0 })
	new("UICorner", { Parent = tframe, CornerRadius = UDim.new(0, 6) })
	delay(time, function() if tframe and tframe.Parent then tframe:Destroy() end end)
end

-- Toggle runner (mantido para compatibilidade futura; não usado nesta versão)
function toggleScript(entry, stateBtn)
	if entry.enabled then
		if entry.disableFunc then
			local ok, err = pcall(function() entry.disableFunc(entry) end)
			if not ok then warn("Erro ao desativar script:", err) end
		end
		entry.enabled = false
		if stateBtn then
			stateBtn.Text = "Ativar"
			stateBtn.BackgroundColor3 = Color3.fromRGB(28, 140, 230)
		end
		toast("Desativado: " .. tostring(entry.name), 2)
	else
		if entry.enableFunc then
			local ok, err = pcall(function() entry.enableFunc(entry) end)
			if not ok then
				warn("Erro ao ativar script:", err)
				toast("Erro ao ativar: " .. tostring(err), 4)
				return
			end
		end
		entry.enabled = true
		if stateBtn then
			stateBtn.Text = "Desativar"
			stateBtn.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
		end
		toast("Ativado: " .. tostring(entry.name), 2)
	end
end

-- Build UI & connect logic (apenas Main)
connectCanvasUpdates()
refreshScripts()

-- Minimize logic (compact bar)
local minimized = false
local collapsedBar
btnMin.MouseButton1Click:Connect(function()
	minimized = not minimized
	if minimized then
		-- esconder a janela principal e criar uma barra compacta
		main.Visible = false
		if not collapsedBar or not collapsedBar.Parent then
			collapsedBar = new("Frame", { Parent = screenGui, Size = UDim2.new(0, 160, 0, 48), Position = UDim2.new(0, 20, 0, 20), BackgroundColor3 = Color3.fromRGB(25, 27, 29), ZIndex = 40 })
			new("UICorner", { Parent = collapsedBar, CornerRadius = UDim.new(0, 8) })
			local openBtn = new("TextButton", { Parent = collapsedBar, Text = "Davzx", Font = Enum.Font.GothamBold, TextSize = 16, TextColor3 = Color3.fromRGB(235, 235, 235), BackgroundTransparency = 1, Size = UDim2.new(1, 0, 1, 0) })
			openBtn.MouseButton1Click:Connect(function()
				minimized = false
				if collapsedBar and collapsedBar.Parent then collapsedBar:Destroy() end
				main.Visible = true
			end)

			-- allow dragging the collapsed bar (supports mouse and touch)
			local draggingCollapsed = false
			local startPosCollapsed, startBarPos
			openBtn.InputBegan:Connect(function(input)
				if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
					draggingCollapsed = true
					startPosCollapsed = input.Position
					startBarPos = collapsedBar.Position
					input.Changed:Connect(function()
						if input.UserInputState == Enum.UserInputState.End then draggingCollapsed = false end
					end)
				end
			end)
			RunService.RenderStepped:Connect(function()
				if draggingCollapsed and startPosCollapsed and startBarPos and collapsedBar and collapsedBar.Parent then
					local cur = UserInputService:GetMouseLocation()
					local delta = cur - startPosCollapsed
					collapsedBar.Position = UDim2.new(startBarPos.X.Scale, startBarPos.X.Offset + delta.X, startBarPos.Y.Scale, startBarPos.Y.Offset + delta.Y)
				end
			end)
		end
	else
		if collapsedBar and collapsedBar.Parent then collapsedBar:Destroy() end
		main.Visible = true
	end
end)

-- Close behavior: destrói a GUI completamente
btnClose.MouseButton1Click:Connect(function()
	if screenGui and screenGui.Parent then
		screenGui:Destroy()
	end
end)

-- Draggable window (topbar) - suporta mouse e touch
local draggingWindow = false
local dragStartPos, windowStartPos

topbar.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		draggingWindow = true
		dragStartPos = input.Position
		windowStartPos = main.Position
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				draggingWindow = false
			end
		end)
	end
end)

RunService.RenderStepped:Connect(function()
	if draggingWindow and dragStartPos and windowStartPos then
		local cur = UserInputService:GetMouseLocation()
		local delta = cur - dragStartPos
		main.Position = UDim2.new(windowStartPos.X.Scale, windowStartPos.X.Offset + delta.X, windowStartPos.Y.Scale, windowStartPos.Y.Offset + delta.Y)
	end
end)

-- Responsiveness: ajustar tamanho de acordo com viewport (mobile friendly)
local function adjustForScreen()
	local viewportX, viewportY = 1280, 720
	if workspace.CurrentCamera and workspace.CurrentCamera.ViewportSize then
		viewportX = workspace.CurrentCamera.ViewportSize.X
		viewportY = workspace.CurrentCamera.ViewportSize.Y
	end

	-- Telas muito pequenas => quase full-screen mas com margens
	if viewportX <= 700 then
		main.Size = UDim2.new(0.95, 0, 0.92, 0)
		main.Position = UDim2.new(0.5, 0, 0.5, 0)
	else
		-- Desktop/tablet: limitar largura e altura máximas para não ocupar inteira
		local w = math.clamp(math.floor(viewportX * 0.7), 560, 1000)
		local h = math.clamp(math.floor(viewportY * 0.7), 380, 760)
		main.Size = UDim2.new(0, w, 0, h)
		main.Position = UDim2.new(0.5, 0, 0.5, 0)
	end
end
workspace:GetPropertyChangedSignal("CurrentCamera"):Connect(adjustForScreen)
adjustForScreen()

delay(0.5, function() toast("UI carregada — aba Main ativa", 3) end)
